// index.js

// Carga las variables de entorno desde .env (DEBE SER LA PRIMERA LÃNEA)
require('dotenv').config(); 

const express = require('express');
const cors = require('cors');
const app = express();
// Usa la variable de entorno para el puerto, si no existe, usa 3000
const port = process.env.PORT || 3000; 

// Importa la configuraciÃ³n de la base de datos (Sequelize y modelos)
const db = require('./config/db.config'); 

// Middleware
app.use(cors());
app.use(express.json());


// ==========================================================
// CONFIGURACIÃ“N DE RUTAS API (CONTROLADORES)
// ==========================================================

// --- 1. Rutas de Estudiantes ---
app.get('/api/estudiantes', async (req, res) => {
    try {
        // Incluye el modelo Grupo para ver la relaciÃ³n al consultar
        // NOTA: Si el modelo Grupo aÃºn no existe o no tiene las relaciones definidas, esto fallarÃ¡. 
        // Si tienes problemas, quita el 'include' temporalmente.
        const data = await db.Estudiante.findAll({
            // include: [{ model: db.Grupo, attributes: ['grado', 'grupo'] }] // Descomenta solo si tienes la relaciÃ³n Grupo
        }); 
        res.json(data); 
    } catch (error) {
        console.error("Error al obtener estudiantes:", error);
        res.status(500).send({ message: "Error en el servidor al consultar estudiantes. Â¿La BD estÃ¡ activa?" });
    }
});

// NUEVA RUTA: Registrar un nuevo estudiante
app.post('/api/estudiantes', async (req, res) => {
    try {
        // Intenta crear el estudiante usando los datos enviados
        const nuevoEstudiante = await db.Estudiante.create(req.body);
        res.status(201).json(nuevoEstudiante);
    } catch (error) {
        // LÃ³gica de DEBUGGING para capturar el error detallado
        console.error("--- ERROR AL CREAR ESTUDIANTE (DETALLE) ---");
        console.error("Cuerpo de la PeticiÃ³n (Req. Body):", req.body);
        console.error("Nombre del Error:", error.name);
        console.error("Mensaje Completo del Error:", error.message);
        console.error("-------------------------------------------");

        if (error.name === 'SequelizeValidationError') {
            return res.status(400).send({ message: "Error de validaciÃ³n: Faltan campos requeridos o el formato es incorrecto.", details: error.errors });
        }
        if (error.name === 'SequelizeForeignKeyConstraintError') {
            return res.status(400).send({ message: "Error de Clave ForÃ¡nea: El profesor asignado no existe.", details: error.message });
        }
        
        res.status(500).send({ message: "Error en el servidor al registrar el estudiante." });
    }
});


// ==========================================================
// 2. SINCRONIZACIÃ“N DE LA BASE DE DATOS, SEEDING Y ARRANQUE
// ==========================================================

// ðŸ’¡ IMPORTANTE: 'force: true' BORRARÃ Y RECREARÃ TODAS LAS TABLAS CADA VEZ QUE INICIES EL SERVIDOR.
db.sequelize.sync({ force: true }) 
  .then(async () => {
    console.log("-----------------------------------------");
    console.log("Â¡ConexiÃ³n a la BD exitosa!");
    console.log("Modelos sincronizados (y RECREADOS) con la Base de Datos: gestion_escolar");
    
    // ðŸ’¡ SEEDING TEMPORAL PARA EVITAR FALLOS DE CLAVE FORÃNEA ðŸ’¡
    const countProfesores = await db.Profesor.count();
    if (countProfesores === 0) {
        await db.Profesor.create({
            identificacion: 'CC999999999',
            nombre: 'Profesor GuÃ­a Base',
            email: 'base@escuela.com',
            especialidad: 'General',
            estado: 'Activo'
        });
        console.log("âœ… Se insertÃ³ un Profesor de prueba (ID 1) para las claves forÃ¡neas.");
    }
    
    // ðŸ’¡ SEEDING DE UN ESTUDIANTE DE PRUEBA (Â¡CAMPOS CORREGIDOS!) ðŸ’¡
    // NOTA: Se usan los campos correctos (primer_nombre, documento_numero, fecha_nacimiento, etc.)
    const countEstudiantes = await db.Estudiante.count();
    if (countEstudiantes === 0) {
        await db.Estudiante.create({
            codigo: "TEST001",
            identificacion_tipo: "TI", // Tipo de documento es obligatorio
            documento_numero: "9999999999", // NÃºmero de documento es obligatorio
            primer_nombre: "Estudiante", // Primer nombre es obligatorio
            primer_apellido: "Prueba", // Primer apellido es obligatorio
            sexo: "M", // Sexo es obligatorio
            fecha_nacimiento: "2010-01-01", // Fecha de nacimiento es obligatorio
            estado: "En curso",
            // Se asume que el campo profesor_guia_id existe en el modelo y estÃ¡ definido como relaciÃ³n.
            // Si el campo no existe en el modelo, descomenta esta lÃ­nea:
            // profesor_guia_id: 1 
        });
        console.log("âœ… Se insertÃ³ un Estudiante de Prueba para confirmar el GET.");
    }

    console.log("-----------------------------------------");
    
    // app.listen() se ejecuta SOLO despuÃ©s de la conexiÃ³n exitosa
    app.listen(port, () => {
      console.log(`Servidor corriendo en http://localhost:${port}`);
    });

  })
  .catch((err) => {
    console.error("Â¡ERROR DE CONEXIÃ“N A LA BD O SINCRONIZACIÃ“N!");
    console.error("El servidor NO se ha iniciado.");
    console.error("Detalle del error:", err.message);
    process.exit(1); 
  });
